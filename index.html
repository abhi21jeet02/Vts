
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vehicle Tracking Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div class="max-w-7xl mx-auto p-4">
    <h1 class="text-3xl font-bold text-center mb-6">üöö Vehicle Tracking System</h1>

    <!-- Action Buttons -->
    <div class="flex justify-end space-x-4 mb-4">
      <button onclick="openGateForm()" class="bg-green-600 text-white px-4 py-2 rounded">‚ûï Gate Entry</button>
      <button onclick="openStore()" class="bg-blue-600 text-white px-4 py-2 rounded">üè≠ Store</button>
    </div>

    <!-- Dashboard Table -->
    <div class="overflow-x-auto bg-white shadow rounded-lg">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200 text-left">
            <th class="px-3 py-2 border">Vehicle No</th>
            <th class="px-3 py-2 border">Driver</th>
            <th class="px-3 py-2 border">Mobile</th>
            <th class="px-3 py-2 border">Supplier</th>
            <th class="px-3 py-2 border">Purpose</th>
            <th class="px-3 py-2 border">Status</th>
            <th class="px-3 py-2 border">Dock</th>
            <th class="px-3 py-2 border">Gate In</th>
            <th class="px-3 py-2 border">Gate Out</th>
          </tr>
        </thead>
        <tbody id="dashboardTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal: Gate Form -->
  <div id="gateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-lg">
      <h2 class="text-xl font-semibold mb-4">üö™ Vehicle Gate Entry</h2>
      <form id="gateForm" class="space-y-3">
        <input id="vehicleNo" type="text" placeholder="Vehicle Number" class="border p-2 rounded w-full" required>
        <input id="driverName" type="text" placeholder="Driver Name" class="border p-2 rounded w-full" required>
        <input id="driverMobile" type="text" placeholder="Driver Mobile" class="border p-2 rounded w-full" required>
        <input id="supplier" type="text" placeholder="Supplier Name" class="border p-2 rounded w-full">
        <select id="purpose" class="border p-2 rounded w-full" required>
          <option value="">-- Select Purpose --</option>
          <option value="Loading">Loading</option>
          <option value="Unloading">Unloading</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Visitor">Visitor</option>
          <option value="Other">Other</option>
        </select>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeGateForm()" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
          <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Store -->
  <div id="storeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-4xl">
      <h2 class="text-xl font-semibold mb-4">üè≠ Store Operations</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="px-3 py-2 border">Vehicle No</th>
            <th class="px-3 py-2 border">Driver</th>
            <th class="px-3 py-2 border">Dock</th>
            <th class="px-3 py-2 border">Operation</th>
            <th class="px-3 py-2 border">Action</th>
          </tr>
        </thead>
        <tbody id="storeTable"></tbody>
      </table>
      <div class="flex justify-end mt-4">
        <button onclick="closeStore()" class="bg-gray-400 text-white px-4 py-2 rounded">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDxzNeMBXn3glNwJuEH_XpeYqz7nI7fzqw",
      authDomain: "vts-system-750f7.firebaseapp.com",
      projectId: "vts-system-750f7",
      storageBucket: "vts-system-750f7.firebasestorage.app",
      messagingSenderId: "444449653384",
      appId: "1:444449653384:web:d5e1d4f56c8e182cc8d53d",
      measurementId: "G-TX3ZFD2HBW"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Dashboard
    const dashboardTable = document.getElementById("dashboardTable");

    onSnapshot(collection(db, "vehicles"), (snapshot) => {
      dashboardTable.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const v = docSnap.data();
        const rowColor =
          v.status === "Inside" ? "bg-green-100" :
          v.status === "Exited" ? "bg-red-100" :
          v.status === "Dock" ? "bg-yellow-100" : "";

        dashboardTable.innerHTML += `
          <tr class="${rowColor}">
            <td class="border px-3 py-2">${v.vehicleNo}</td>
            <td class="border px-3 py-2">${v.driverName}</td>
            <td class="border px-3 py-2">${v.driverMobile}</td>
            <td class="border px-3 py-2">${v.supplier}</td>
            <td class="border px-3 py-2">${v.purpose}</td>
            <td class="border px-3 py-2">${v.status}</td>
            <td class="border px-3 py-2">${v.dock || ""}</td>
            <td class="border px-3 py-2">${v.gateInTime}</td>
            <td class="border px-3 py-2">${v.gateOutTime || ""}</td>
          </tr>`;
      });
    });

    // Gate Form Modal
    window.openGateForm = () => document.getElementById("gateModal").classList.remove("hidden");
    window.closeGateForm = () => document.getElementById("gateModal").classList.add("hidden");

    // Save Vehicle Entry (no duplicates)
    const gateForm = document.getElementById("gateForm");
    gateForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const vehicleNo = document.getElementById("vehicleNo").value.trim().toUpperCase();
      const driverName = document.getElementById("driverName").value;
      const driverMobile = document.getElementById("driverMobile").value;
      const supplier = document.getElementById("supplier").value;
      const purpose = document.getElementById("purpose").value;

      // Check duplicates
      const q = query(collection(db, "vehicles"), where("vehicleNo", "==", vehicleNo), where("status", "==", "Inside"));
      const existing = await getDocs(q);
      if (!existing.empty) {
        alert("‚ùå Vehicle already inside premises!");
        return;
      }

      await addDoc(collection(db, "vehicles"), {
        vehicleNo,
        driverName,
        driverMobile,
        supplier,
        purpose,
        status: "Inside",
        dock: "",
        gateInTime: new Date().toLocaleString(),
        gateOutTime: ""
      });

      gateForm.reset();
      closeGateForm();
    });

    // Store Modal
    window.openStore = () => {
      document.getElementById("storeModal").classList.remove("hidden");
      loadStoreTable();
    };
    window.closeStore = () => document.getElementById("storeModal").classList.add("hidden");

    async function loadStoreTable() {
      const storeTable = document.getElementById("storeTable");
      storeTable.innerHTML = "";

      onSnapshot(query(collection(db, "vehicles"), where("status", "==", "Inside")), (snapshot) => {
        storeTable.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const v = docSnap.data();
          const id = docSnap.id;

          storeTable.innerHTML += `
            <tr>
              <td class="border px-3 py-2">${v.vehicleNo}</td>
              <td class="border px-3 py-2">${v.driverName}</td>
              <td class="border px-3 py-2">
                <select onchange="assignDock('${id}', this.value)" class="border p-1 rounded">
                  <option value="">--Select--</option>
                  <option value="Dock 1">Dock 1</option>
                  <option value="Dock 2">Dock 2</option>
                  <option value="Dock 3">Dock 3</option>
                </select>
              </td>
              <td class="border px-3 py-2">
                <select onchange="updatePurpose('${id}', this.value)" class="border p-1 rounded">
                  <option value="">--Select--</option>
                  <option value="Loading">Loading</option>
                  <option value="Unloading">Unloading</option>
                  <option value="Completed">Completed</option>
                </select>
              </td>
              <td class="border px-3 py-2">
                <button onclick="gateOut('${id}')" class="bg-red-500 text-white px-2 py-1 rounded">Gate Out</button>
              </td>
            </tr>`;
        });
      });
    }

    // Assign Dock
    window.assignDock = async (id, dockNo) => {
      const ref = doc(db, "vehicles", id);
      await updateDoc(ref, { dock: dockNo, status: "Dock" });
    };

    // Update Purpose
    window.updatePurpose = async (id, purpose) => {
      const ref = doc(db, "vehicles", id);
      await updateDoc(ref, { purpose });
    };

    // Gate Out
    window.gateOut = async (id) => {
      const ref = doc(db, "vehicles", id);
      await updateDoc(ref, {
        status: "Exited",
        gateOutTime: new Date().toLocaleString()
      });
    };
  </script>
</body>
</html>
